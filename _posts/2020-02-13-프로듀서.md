# 프로듀서

프로듀서가 카프카로 메세지를 보내려면 '토픽'이 생성되어 있어야 한다.

auto.create.topics.enable=true로 카프카 옵션을 설정하면, 존재하지 않는 토픽으로 메세지를 보내더라도 카프카가 스스로 토픽을 생성해준다.

→ 토픽을 생성할 때 이름, 파티션 개수, replication factor 수를 정해준다.

(kafka-topics.sh을 통해 사전에 토픽을 생성할 때 주키퍼 리스트를 주는 이유는 뭔지 모르겠으니 찾아보자)

(producer, consumer .sh 파일을 이용해서 메세지를 주고 받을 때 카프카 리스트를 주는 이유는 뭔지 모르겠으니 찾아보자)

acks를 옵션으로 넣을 수도 있고, 압축방식을 지정할 수도 있다.

- 자바에서 보내는 방법
- 메세지 성공여부 상관없이 보내는 방법
- 동기로 보내는 방법(Future.get())
- 비동기 콜백(org.apache.kafka.clients.producer.Callback을 구현하는 클래스)
- key를 지정해서 특정 파티션으로 메시지가 가도록 할 수 있음 (어떻게 키값으로 파티션을 찾았는지는 모르겠으니 찾아봐야함)

## 주요 옵션

- bootstrap.servers : 카프카 클러스터는 마스터개념이 없기 때문에 모든 서버가 클라이언트의 요청을 받을 수 있다.
- acks : 프로듀서가 카프카 토픽의 리더에게 메세지를 보낸 후 요청을 완료하기 전 ack의 수. 이 값이 작으면 성능은 좋지만 메시지 손실 가능성이 있고, 수가 크면 성능은 떨어지나 메세지 손실 가능성이 떨어지거나 없을 수 있음 (ack=0으로 지정하면 어떠한 ack도 기다리지 않음, ack=1은 리더는 모든 데이터를 기록하나 팔로워는 확인하지 않음, ack=all or -1은 ISR의 팔로워로부터 데이터에 대한 ack를 기다림. 즉, 무손실 보장)
- buffer.memory : 프로듀서가 카프카 서버로 데이터를 보내기 위해 대기할 수 있는 전체 메모리 바이트
- compression.type : 데이터 압축 타입(none, gzip, snappy, lz4, ...)
- retries : 오류로 인해 전송에 실패한 데이터를 다시 보내게 됨.
- batch.size : 배치로 데이터를 보낼 때 배치의 크기 단위를 조정할 수 있음, 정해진 크기보다 큰 배치 데이터는 수행하지 않음
- [linger.ms](http://linger.ms) : 배치형태의 메시지를 보내기 전에 추가적인 메세지들을 위해 기다리는 시간. 카프카 프로듀서는 지정된 배치 사이즈에 도달하면 이 옵션과 상관없이 즉시 전송하고, 배치사이즈에 도달하지 못한 상황에서 linger.ms 제한시간에 도달했을 때 메세지들을 전송. 기본은 0으로 지연없이 보낸다. 설정해서 약간의 지연은 발생시키더라도 처리량이 좋아지니까 사용하자.
- max.request.size : 프로듀서가 보낼 수 있는 메시지의 최대 사이즈 (기본 1MB)

acks 는 보통 1을 추천함.(안정성과 속도 확보)

## 프로듀서만 acks=all로 하면 무손실을 보장하는가?

아니다. 만약 카프카 브로커에서 min.insync.replicas 가 1로 설정되어있으면 리더는 최소 리플리케이션 조건을 갖췄다고 판단하면 바로 acks를 보냅니다.

이럴 때 자신만 받았는데 acks를 보냈으니까 손실이 일어날 수 있습니다.

- 만약 무손실을 보장해야한다면 어떻게 해야할까?

acks=all, min.insync.replicas=2, replication factor=3조건을 사용하는게 추천된다.

이러면 최소 리플리케이션이 2이므로 리더말고 팔로워 하나가 데이터를 갖고 있음이 보장이 되기 때문이다.

min.insync.replicas=3으로 하지 않는 이유는 만약 팔로워가 하나라도 죽으면 min.insync.replicas가 3인데 브로커가 2개밖에 없으므로 프로듀서의 메시지를 처리할 수 없게 된다. 이러면 가용성이 떨어지면서(사실상 서비스 불가) 문제가 발생하기때문에 위와같이 추천되는 것이다.